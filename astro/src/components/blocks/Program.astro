---
import AvegaTitle from "@components/shared/AvegaTitle.astro";
import NotchArrow from "@components/shared/NotchArrow.astro";
import { cn } from "@lib/cn";
import { getImageUrl } from "@lib/imageUtils";
import { Image } from "astro:assets";

interface Category {
	id: number;
	title: string;
	icon?: {
		url: string;
		alternativeText: string;
	};
}

interface Speaker {
	id: number;
	firstname: string;
	lastname: string;
	company: string;
	image?: {
		url: string;
		alternativeText: string;
	};
}

interface Room {
	id: number;
	title: string;
}

interface Conference {
	id: number;
	slug: string;
	title: string;
	speakers: Speaker[];
	startTime: string;
	endTime: string;
	duration: string;
	description: string;
	room: Room;
	categories: Category[];
}

interface StageProgram {
	title: string;
	conferences: Conference[];
}

interface Props {
	anchor?: string;
	zIndex: number;
	StageProgram: StageProgram[];
	hasNotch: boolean;
	previousBlockHasNotch: boolean;
}

const strapiUrl = import.meta.env.STRAPI_URL;
const { anchor, zIndex, StageProgram, hasNotch, previousBlockHasNotch } = Astro.props;

---

<section
	id={anchor}
	class={`relative ${hasNotch ? 'pb-notch' : ''} ${previousBlockHasNotch ? 'mt-notch' : ''}`}
	style={{ zIndex: zIndex }}
	data-header-color={true}
>
	<div class={`relative bg-white`} data-notch-border-color={hasNotch ? '#1B1C5D' : undefined}>
		<div class={cn("mx-auto max-w-screen-xl px-6 xs:px-8 w-full py-24 xs:py-32 md:py-48", !previousBlockHasNotch && "!pt-0")}>
			<div class="bg-white">
				{StageProgram && StageProgram.map((stage) => (
					<div class="mb-16 last:mb-0">
						<AvegaTitle
							title={stage.title}
							level={3}
							color="#CA5FF9"
							className="mb-8"
						/>

						<div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6">
							{stage.conferences && stage.conferences.map((conference) => {
								return (
									<a href={`/programme/${conference.slug}`} class="conference-card relative rounded-xl overflow-hidden h-[320px] w-full p-3 block transition-transform hover:scale-105 z-10">
										{/* Background gradient */}
										<div class="absolute inset-0 w-full h-full bg-gradient-to-br from-purple-600 to-blue-600" />

										<div class="relative h-full flex flex-col justify-between p-3 border border-white rounded-lg">
											<div class="conference-title-no-shadow">
												<AvegaTitle
													title={conference.title}
													level={6}
													color="#ffffff"
													className="line-clamp-2 !text-md"
												/>
											</div>

											{conference.speakers && conference.speakers.length > 0 && (
												<div class={cn("grid gap-3", conference.speakers.length > 1 ? "grid-cols-2" : "grid-cols-1" )}>
													{conference.speakers.map((speaker) => {
														const speakerImage = speaker.image;
														const speakerImageUrl = speakerImage ? getImageUrl(speakerImage.url, strapiUrl) : null;
														return (
															<div class="flex items-center gap-2">
																{speakerImageUrl && (
																	<Image
																		src={speakerImageUrl}
																		alt={`${speaker.firstname} ${speaker.lastname}`}
																		width="40"
																		height="40"
																		class="size-10 rounded-full object-cover border-2 border-white flex-shrink-0"
																	/>
																)}
																<div class="min-w-0">
																	<p class="text-white font-medium text-sm">
																		{speaker.firstname} {speaker.lastname}
																	</p>
																	<p class="text-white/70 font-medium text-sm">
																		{speaker.company}
																	</p>
																</div>
															</div>
														);
													})}
												</div>
											)}

											{conference.categories && conference.categories.length > 0 && (
												<div class="flex flex-wrap gap-2">
													{conference.categories.map((category) => {
														const categoryIcon = category.icon;
														const iconUrl = categoryIcon ? getImageUrl(categoryIcon.url, strapiUrl) : null;
														return (
															<div class="flex items-center gap-2 bg-white/20 backdrop-blur-sm px-2 py-1 rounded-full text-sm text-white border border-white">
																{iconUrl && (
																	<Image
																		src={iconUrl}
																		alt={category.title}
																		width="16"
																		height="16"
																		class="size-4"
																	/>
																)}
																<span class="text-xs">{category.title}</span>
															</div>
														);
													})}
													<div class="flex items-center gap-2 bg-white/20 backdrop-blur-sm px-2 py-1 rounded-full text-sm text-white border border-white">
														<span class="text-xs">{conference.startTime} - {conference.endTime}</span>
													</div>
													<div class="flex items-center gap-2 bg-white/20 backdrop-blur-sm px-2 py-1 rounded-full text-sm text-white border border-white">
														<span class="text-xs">{conference.duration}</span>
													</div>
												</div>
											)}
										</div>
									</a>
								);
							})}
						</div>
					</div>
				))}
			</div>
		</div>

	{hasNotch && (
		<NotchArrow color="#9A89FD" />
	 )}
	</div>
</section>

<style>
	.conference-title-no-shadow :global(.avega) {
		text-shadow: none !important;
	}
</style>
