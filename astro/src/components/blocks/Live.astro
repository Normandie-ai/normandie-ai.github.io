---
import { Image } from "astro:assets";
import { getImageUrl } from "@lib/imageUtils";
import NotchArrow from "@components/shared/NotchArrow.astro";
import AvegaTitle from "@components/shared/AvegaTitle.astro";
import { configureMarkdown, parseMarkdown } from "@lib/markdown";

interface Props {
  anchor?: string;
  zIndex: number;
	title: string;
  titleImage: {
		url: string;
		alternativeText: string;
	};
  content: string;
  embedUrl?: string;
  variant: "default" | "dark";
  hasNotch: boolean;
  previousBlockHasNotch: boolean;
}
const strapiUrl = import.meta.env.STRAPI_URL;

const { anchor, zIndex, title, titleImage, content, variant, embedUrl, hasNotch, previousBlockHasNotch } = Astro.props;

const imageUrl = getImageUrl(titleImage?.url, strapiUrl);

// Configure marked to properly handle markdown
configureMarkdown();
const parsedContent =  parseMarkdown(content);

// Determine container layout based on whether we have embed
const hasEmbed = !!embedUrl;
const containerClass = hasEmbed
  ? "grid grid-cols-1 lg:grid-cols-2 gap-12 items-start"
  : "flex justify-center";

// Apply background color if provided
const variantColor = variant === "dark" ? "#191958" : "#ffffff";
const sectionStyle = `background-color: ${variantColor}`;
const arrowColor = variant === "dark" ? "#ffffff" : "#CF65FB";
---

<style>
  .blur-circle {
    background: #4863B7;
    opacity: 0.7;
  }
</style>

<section id={anchor} style={`z-index: ${zIndex}`} class=`relative overflow-hidden ${hasNotch ? 'pb-notch' : ''} ${previousBlockHasNotch ? 'mt-notch' : ''}` data-header-color={variant !== "dark"}>
  <div class={`relative mx-auto`} style={sectionStyle} data-notch-border-color={hasNotch ? variantColor : undefined}>
    <!-- Decorative blurred circles - only show for dark variant -->
    {variant === "dark" && (
      <>
        <div class="absolute top-0 -left-20 w-[32rem] h-[32rem] rounded-full filter blur-3xl blur-circle"></div>
        <div class="absolute bottom-0 right-2 w-[38rem] h-[38rem] rounded-full filter blur-3xl blur-circle"></div>
      </>
    )}
    
    <div class="mx-auto max-w-screen-xl px-6 xs:px-8 py-24 xs:py-32 md:py-48 relative z-10">
      <!-- Title Section - Centered at top -->
      <div class="flex justify-center mb-12">
        {title && (
          <AvegaTitle title={title} level={2} size={4} color={variant === "dark" ? "#ffffff" : "#725CFA"} />
        )}
      </div>

      <div class={containerClass}>
        <!-- Content Section -->
        <div class="order-2 lg:order-1">
          <div class="max-w-lg md:max-w-none">
            {imageUrl && (
              <Image src={imageUrl}
                  alt={titleImage.alternativeText || ""}
                  width="337"
                  height="70"
                  loading="lazy"
              />
            )}
            <div class=`mt-4 prose prose-strong:font-bold max-w-none ${variant === 'dark' ? 'prose-invert' : ''}` style={variant === "dark" ? `color: white` : ''}>
              <article set:html={parsedContent} />
            </div>
          </div>
        </div>

        <!-- Embed Section -->
        {embedUrl && (
          <div class="order-1 lg:order-2 flex items-center">
            <div class="relative rounded-2xl overflow-hidden aspect-video w-full mt-20">
              <iframe
                src={embedUrl}
                class="w-full h-full"
                frameborder="0"
                allow="accelerometer; autoplay; clipboard-write; encrypted-media; gyroscope; picture-in-picture"
                allowfullscreen
              ></iframe>
            </div>
          </div>
        )}
      </div>
    </div>

    {hasNotch && (
      <NotchArrow color={arrowColor} />
    )}
  </div>
</section>